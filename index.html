<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Theepika Sweety Gallery üíñ</title>
  <style>
    body { font-family: 'Poppins', sans-serif; background:#111; color:white; margin:0; padding:0; }
    header { text-align:center; padding:15px; background:#1b1b1b; border-bottom:2px solid #333; }
    h1 { margin:0; }
    .gallery { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:15px; padding:20px; }
    .card { background:#222; border-radius:10px; overflow:hidden; text-align:center; padding-bottom:10px; transition:0.2s; }
    .card:hover { transform:scale(1.03); }
    img { width:100%; height:200px; object-fit:cover; }
    .meta { margin:6px 0; font-size:0.9rem; color:#bbb; }
    button { background:#ff3e6c; border:none; color:white; border-radius:20px; padding:6px 12px; cursor:pointer; }
    button:disabled { background:#555; cursor:not-allowed; }
    .upload-box { text-align:center; margin:20px auto; background:#1b1b1b; padding:20px; border-radius:10px; width:90%; max-width:400px; }
    input,button { margin:6px; width:90%; padding:8px; }
    .viewer { text-align:center; padding:20px; }
    .viewer img { width:90%; max-width:600px; border-radius:10px; }
  </style>
</head>
<body>
<header>
  <h1>üì∑ Theepika Sweety Gallery</h1>
</header>

<div class="upload-box">
  <h3>Admin Upload (You Only)</h3>
  <input type="file" id="fileInput">
  <input type="text" id="title" placeholder="Title (optional)">
  <input type="password" id="token" placeholder="GitHub Token">
  <button onclick="upload()">Upload</button>
  <p id="status"></p>
</div>

<div id="gallery" class="gallery"></div>

<script>
const repo = "adfly450/theepika_sweety"; // <-- ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç GitHub repo ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç
const branch = "main";
const dataUrl = `https://raw.githubusercontent.com/${repo}/${branch}/docs/data.json`;

async function loadGallery(){
  const res = await fetch(dataUrl + '?_=' + Date.now());
  const list = await res.json();
  const g = document.getElementById("gallery");
  g.innerHTML = "";
  list.slice().reverse().forEach(p=>{
    const liked = localStorage.getItem("liked_"+p.id);
    g.innerHTML += `
      <div class="card">
        <img src="${p.url}" onclick="openView('${p.id}')">
        <div class="meta">${p.title || "Untitled"}</div>
        <div class="meta">üëÅÔ∏è ${p.views || 0} ‚ù§Ô∏è ${p.likes || 0}</div>
        <button onclick="like('${p.id}')" id="btn_${p.id}" ${liked?"disabled":""}>${liked?"Liked":"Like"}</button>
      </div>`;
  });
}
loadGallery();

async function upload(){
  const file = document.getElementById('fileInput').files[0];
  const title = document.getElementById('title').value;
  const token = document.getElementById('token').value;
  const msg = document.getElementById('status');
  if(!file || !token){ msg.textContent="File + Token ‡Æ§‡Øá‡Æµ‡Øà!"; return; }
  msg.textContent="‚è≥ Uploading...";
  
  const reader = new FileReader();
  reader.onload = async () => {
    const base64 = reader.result.split(',')[1];
    const filename = Date.now() + "_" + file.name.replace(/\s+/g,'_');
    const uploadUrl = `https://api.github.com/repos/${repo}/contents/docs/uploads/${filename}`;

    // 1Ô∏è‚É£ Get current JSON
    const dataRes = await fetch(dataUrl);
    const list = await dataRes.json();

    // 2Ô∏è‚É£ Upload file to GitHub
    await fetch(uploadUrl, {
      method: "PUT",
      headers: { "Authorization": `token ${token}`, "Content-Type":"application/json" },
      body: JSON.stringify({ message:"Add photo", content: base64 })
    });

    const rawUrl = `https://raw.githubusercontent.com/${repo}/${branch}/docs/uploads/${filename}`;

    // 3Ô∏è‚É£ Update JSON
    list.push({ id: filename, title, url: rawUrl, likes:0, views:0 });
    const newContent = btoa(JSON.stringify(list, null, 2));

    const dataShaRes = await fetch(`https://api.github.com/repos/${repo}/contents/docs/data.json`);
    const dataSha = (await dataShaRes.json()).sha;

    await fetch(`https://api.github.com/repos/${repo}/contents/docs/data.json`, {
      method:"PUT",
      headers: { "Authorization": `token ${token}`, "Content-Type":"application/json" },
      body: JSON.stringify({ message:"Update data.json", content:newContent, sha:dataSha })
    });

    msg.textContent="‚úÖ Uploaded! Refreshing...";
    setTimeout(loadGallery,2000);
  };
  reader.readAsDataURL(file);
}

// üîπ Like system
async function like(id){
  const btn=document.getElementById('btn_'+id);
  btn.disabled=true;
  localStorage.setItem("liked_"+id,"1");

  const dataRes=await fetch(dataUrl);
  const list=await dataRes.json();
  const index=list.findIndex(p=>p.id===id);
  if(index<0)return;

  list[index].likes=(list[index].likes||0)+1;
  const token=prompt("Enter GitHub Token to save like count:");
  if(!token){ alert("Token ‡Æ§‡Øá‡Æµ‡Øà!"); return; }

  const shaRes=await fetch(`https://api.github.com/repos/${repo}/contents/docs/data.json`);
  const sha=(await shaRes.json()).sha;
  const newContent=btoa(JSON.stringify(list,null,2));

  await fetch(`https://api.github.com/repos/${repo}/contents/docs/data.json`,{
    method:"PUT",
    headers:{ "Authorization":`token ${token}`,"Content-Type":"application/json"},
    body:JSON.stringify({message:`Like ${id}`,content:newContent,sha})
  });
  alert("‚ù§Ô∏è Liked saved!");
  loadGallery();
}

// üîπ View counter page
function openView(id){
  const url = `${location.origin}${location.pathname}?view=${id}`;
  window.open(url,'_blank');
}

// Viewer mode (when ?view=)
(async ()=>{
  const params=new URLSearchParams(location.search);
  const view=params.get("view");
  if(!view)return;
  document.body.innerHTML="";
  const data=await fetch(dataUrl).then(r=>r.json());
  const p=data.find(x=>x.id===view);
  if(!p)return document.write("Not found!");

  p.views=(p.views||0)+1;

  const shaRes=await fetch(`https://api.github.com/repos/${repo}/contents/docs/data.json`);
  const sha=(await shaRes.json()).sha;
  const newContent=btoa(JSON.stringify(data,null,2));
  const token=prompt("Enter GitHub Token to update view count:");
  if(!token){ alert("Token ‡Æ§‡Øá‡Æµ‡Øà!"); return; }

  await fetch(`https://api.github.com/repos/${repo}/contents/docs/data.json`,{
    method:"PUT",
    headers:{ "Authorization":`token ${token}`,"Content-Type":"application/json"},
    body:JSON.stringify({message:`View +1 for ${view}`,content:newContent,sha})
  });

  document.body.innerHTML=`
    <div class='viewer'>
      <img src='${p.url}'><br>
      <h3>${p.title||"Untitled"}</h3>
      <p>üëÅÔ∏è ${p.views} views | ‚ù§Ô∏è ${p.likes} likes</p>
      <button disabled>Like Locked (Gallery Only)</button>
      <br><a href='${p.url}' style='color:#0ff'>Download File</a>
    </div>`;
})();
</script>
</body>
</html>
