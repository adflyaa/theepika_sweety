<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>என் Gallery - theepika_sweety</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; padding: 20px; }
    .c { max-width: 1200px; margin: 0 auto; }
    h1 { text-align: center; color: #60a5fa; margin-bottom: 10px; }
    .s { text-align: center; color: #94a3b8; margin-bottom: 30px; }

    .up { background: #1e293b; padding: 20px; border-radius: 12px; margin: 20px 0; display: none; }
    .up.show { display: block; }
    .d { border: 2px dashed #475569; padding: 30px; text-align: center; border-radius: 10px; cursor: pointer; transition: 0.3s; }
    .d:hover { border-color: #60a5fa; background: #1e3a8a20; }
    .p img, .p video { max-height: 180px; margin: 10px 0; border-radius: 8px; display: block; margin: 10px auto; }
    input, textarea, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #475569; background: #334155; color: #e2e8f0; }
    button { background: #3b82f6; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
    button:hover { background: #2563eb; }
    button:disabled { background: #475569; cursor: not-allowed; }

    .g { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
    .cd { background: #1e293b; border-radius: 12px; overflow: hidden; transition: 0.3s; }
    .cd:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.3); }
    .m { width: 100%; height: 250px; object-fit: cover; background: #334155; display: block; }
    .i { padding: 15px; }
    .n { font-weight: bold; color: #60a5fa; margin-bottom: 5px; font-size: 1.1rem; }
    .de { color: #cbd5e1; font-size: 0.9rem; margin-bottom: 10px; }
    .st { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; margin-top: 10px; }
    .l { background: #334155; padding: 6px 12px; border-radius: 6px; cursor: pointer; transition: 0.3s; user-select: none; }
    .l:hover { background: #475569; }
    .l.liked { background: #fecaca; color: #dc2626; }
    .a { display: flex; gap: 8px; margin-top: 10px; }
    .b { flex: 1; padding: 10px; font-size: 0.9rem; border-radius: 6px; border: none; cursor: pointer; color: white; font-weight: bold; transition: 0.3s; }

    .e { text-align: center; padding: 50px; color: #64748b; font-size: 1.2rem; }
    .t { position: fixed; top: 20px; right: 20px; padding: 14px 20px; background: #10b981; color: white; border-radius: 8px; z-index: 1000; animation: slideIn 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    .t.err { background: #ef4444; }

    /* Share Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
    .modal.show { display: flex; }
    .modal-content { background: #1e293b; padding: 25px; border-radius: 16px; max-width: 500px; width: 90%; text-align: center; }
    .modal h3 { color: #60a5fa; margin-bottom: 15px; }
    .link-box { background: #334155; padding: 12px; border-radius: 8px; margin: 15px 0; word-break: break-all; color: #60a5fa; }
    .modal .a { justify-content: center; }
    .modal .b { background: #25d366; }
    .modal .b:hover { background: #128c7e; }

    @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  </style>
</head>
<body>
  <div class="c">
    <h1>என் Gallery</h1>
    <p class="s">உனக்கு மட்டும் தெரியும்... ஆனால் share பண்ணலாம்</p>

    <!-- Upload -->
    <div class="up" id="uploadBox">
      <div class="d" id="dropZone">கோப்பை இழுத்து விடு அல்லது கிளிக் செய்
        <input type="file" id="fileInput" accept="image/*,video/*" hidden />
      </div>
      <div class="p" id="preview"></div>
      <input type="text" id="nameInput" placeholder="பெயர் (optional)" />
      <textarea id="descInput" placeholder="விளக்கம்... (optional)" rows="3"></textarea>
      <button id="uploadBtn" disabled>பதிவேற்று</button>
    </div>

    <div id="fullGallery"></div>
    <div id="publicView" style="display:none;"></div>
  </div>

  <!-- Share Modal -->
  <div class="modal" id="shareModal">
    <div class="modal-content">
      <h3>Share Link Ready!</h3>
      <div class="link-box" id="shareLink"></div>
      <div class="a">
        <button class="b" id="copyBtn">Copy Link</button>
        <button class="b" id="whatsappBtn">WhatsApp-ல் அனுப்பு</button>
        <button class="b" style="background:#ef4444;" onclick="closeModal()">மூடு</button>
      </div>
    </div>
  </div>

  <script>
    const REPO = 'adflyaa/theepika_sweety';
    const DATA_PATH = 'data.json';
    const PASSWORD = 'uu934587kk';
    let files = [];
    let likes = JSON.parse(localStorage.getItem('likes') || '{}');
    let isAdmin = false;
    let lastUploadedId = null;

    const pwd = prompt('Password?');
    if (pwd === PASSWORD) {
      isAdmin = true;
      document.getElementById('uploadBox').classList.add('show');
    }

    const urlParams = new URLSearchParams(location.search);
    const shareId = urlParams.get('id');

    async function loadData() {
      try {
        const res = await fetch(`https://raw.githubusercontent.com/${REPO}/main/${DATA_PATH}?t=${Date.now()}`);
        files = await res.json();
        if (shareId) showPublicView(shareId);
        else if (isAdmin) showFullGallery();
        else document.getElementById('fullGallery').innerHTML = '<div class="e">தனிப்பட்ட Gallery</div>';
        trackViews();
      } catch {
        document.getElementById('fullGallery').innerHTML = '<div class="e">இன்னும் கோப்புகள் இல்லை</div>';
      }
    }

    function showFullGallery() {
      const html = files.map((f, i) => `
        <div class="cd">
          ${f.type.startsWith('image') ? `<img src="${f.data}" class="m">` : `<video src="${f.data}" class="m" controls></video>`}
          <div class="i">
            <div class="n">${f.name}</div>
            ${f.desc ? `<div class="de">${f.desc}</div>` : ''}
            <div class="st">
              <span>Views: ${f.views || 0}</span>
              <div class="l ${likes[f.id] ? 'liked' : ''}" onclick="toggleLike(${i})">
                ${likes[f.id] ? 'Liked' : 'Like'} (${f.likes || 0})
              </div>
            </div>
            <div class="a">
              <button class="b" style="background:#10b981" onclick="downloadFile(${i})">Download</button>
              <button class="b" style="background:#3b82f6" onclick="shareFile(${i})">Share</button>
            </div>
          </div>
        </div>
      `).join('');
      document.getElementById('fullGallery').innerHTML = html || '<div class="e">இன்னும் கோப்புகள் இல்லை</div>';
    }

    function showPublicView(id) {
      const file = files.find(f => f.id === id);
      if (!file) { document.getElementById('publicView').innerHTML = '<div class="e">கோப்பு இல்லை</div>'; return; }
      const i = files.indexOf(file);
      const html = `
        <div class="cd" style="max-width:600px; margin:0 auto;">
          ${file.type.startsWith('image') ? `<img src="${file.data}" class="m">` : `<video src="${file.data}" class="m" controls></video>`}
          <div class="i">
            <div class="n">${file.name}</div>
            ${file.desc ? `<div class="de">${file.desc}</div>` : ''}
            <div class="st">
              <span>Views: ${file.views || 0}</span>
              <div class="l ${likes[file.id] ? 'liked' : ''}" onclick="toggleLike(${i})">
                ${likes[file.id] ? 'Liked' : 'Like'} (${file.likes || 0})
              </div>
            </div>
            <div class="a">
              <button class="b" style="background:#10b981" onclick="downloadFile(${i})">Download</button>
            </div>
          </div>
        </div>
      `;
      document.getElementById('publicView').innerHTML = html;
      document.getElementById('publicView').style.display = 'block';
      document.getElementById('fullGallery').style.display = 'none';
    }

    function toggleLike(i) {
      const id = files[i].id;
      if (likes[id]) { showToast('ஏற்கனவே like!', true); return; }
      files[i].likes = (files[i].likes || 0) + 1;
      likes[id] = true;
      localStorage.setItem('likes', JSON.stringify(likes));
      updateData();
      shareId ? showPublicView(shareId) : showFullGallery();
      showToast('Liked!');
    }

    function shareFile(i) {
      const id = files[i].id;
      const url = `${location.origin}${location.pathname}?id=${id}`;
      document.getElementById('shareLink').textContent = url;
      document.getElementById('copyBtn').onclick = () => { navigator.clipboard.writeText(url); showToast('Copied!'); };
      document.getElementById('whatsappBtn').onclick = () => window.open(`https://wa.me/?text=${encodeURIComponent(url)}`, '_blank');
      document.getElementById('shareModal').classList.add('show');
    }

    function downloadFile(i) {
      const a = document.createElement('a');
      a.href = files[i].data; a.download = files[i].name; a.click();
    }

    function trackViews() {
      if (!shareId) return;
      const views = JSON.parse(sessionStorage.getItem('views') || '{}');
      if (!views[shareId]) {
        const f = files.find(f => f.id === shareId);
        if (f) { f.views = (f.views || 0) + 1; views[shareId] = true; sessionStorage.setItem('views', JSON.stringify(views)); updateData(); }
      }
    }

    async function updateData() {
      if (!isAdmin) return;
      try {
        const sha = await fetch(`https://api.github.com/repos/${REPO}/contents/${DATA_PATH}`).then(r => r.json()).then(d => d.sha);
        await fetch(`https://api.github.com/repos/${REPO}/contents/${DATA_PATH}`, {
          method: 'PUT',
          headers: { 'Authorization': 'token GH_PAT_WILL_BE_HERE', 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: 'Update', content: btoa(unescape(encodeURIComponent(JSON.stringify(files)))), sha })
        });
      } catch (e) { console.error(e); }
    }

    // Upload
    document.getElementById('dropZone').onclick = () => document.getElementById('fileInput').click();
    document.getElementById('fileInput').onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const r = new FileReader();
      r.onload = ev => {
        const p = file.type.startsWith('image') ? `<img src="${ev.target.result}">` : `<video src="${ev.target.result}" controls></video>`;
        document.getElementById('preview').innerHTML = p;
        document.getElementById('uploadBtn').disabled = false;
      };
      r.readAsDataURL(file);
    };

    document.getElementById('uploadBtn').onclick = () => {
      const file = document.getElementById('fileInput').files[0];
      const name = document.getElementById('nameInput').value || file.name;
      const desc = document.getElementById('descInput').value;
      const r = new FileReader();
      r.onload = ev => {
        const newFile = { id: Date.now().toString(), name, desc, data: ev.target.result, type: file.type, likes: 0, views: 0 };
        files.unshift(newFile);
        lastUploadedId = newFile.id;
        updateData();
        loadData();
        clearUpload();
        showToast('Uploaded! Sharing...');
        setTimeout(() => shareFile(0), 500); // Show share modal
      };
      r.readAsDataURL(file);
    };

    function clearUpload() {
      ['preview', 'nameInput', 'descInput', 'fileInput'].forEach(id => document.getElementById(id).value = '');
      document.getElementById('preview').innerHTML = '';
      document.getElementById('uploadBtn').disabled = true;
    }

    function closeModal() { document.getElementById('shareModal').classList.remove('show'); }

    function showToast(m, err = false) {
      const t = document.createElement('div');
      t.className = 't' + (err ? ' err' : '');
      t.textContent = m;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    loadData();
  </script>
</body>
</html>
